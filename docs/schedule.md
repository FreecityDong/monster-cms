# 1. ç™»å½•é‰´æƒé—­ç¯

| æ¨¡å—     | åŠŸèƒ½                                         |
| -------- | -------------------------------------------- |
| ç”¨æˆ·æ³¨å†Œ | å¯†ç å®æ—¶è§„åˆ™æ ¡éªŒ + æ³¨å†ŒæˆåŠŸå 3 ç§’è·³è½¬ç™»å½•   |
| ç™»å½•     | JWT ç™»å½•ï¼Œtoken å­˜å‚¨åœ¨ localStorage          |
| ç”¨æˆ·ä¿¡æ¯ | /auth/me è·å–ç™»å½•ç”¨æˆ·ä¿¡æ¯ï¼ˆDashboardï¼‰       |
| ä¿®æ”¹å¯†ç  | ç™»å½•åå¯ä¿®æ”¹å¯†ç ï¼Œå¸¦è§„åˆ™æ ¡éªŒä¸æç¤º           |
| å¿˜è®°è´¦å· | é‚®ä»¶å‘é€ç”¨æˆ·åæç¤º                           |
| å¿˜è®°å¯†ç  | é‚®ä»¶é‡ç½®å¯†ç é“¾æ¥ + å‰ç«¯é‡ç½®è¡¨å• + å€’è®¡æ—¶è·³è½¬ |
| åå°ç®¡ç† | Django Admin ç®¡ç†ç”¨æˆ·åŠè§’è‰²                  |
| è·¨åŸŸé€šä¿¡ | CORS é…ç½®ï¼ˆNext.js â†” Djangoï¼‰                |
| å®‰å…¨æ ¡éªŒ | åç«¯å¯†ç å¤æ‚åº¦éªŒè¯ã€JWT é‰´æƒä¸­é—´ä»¶           |

web_dev/
â”œâ”€â”€ backend/
â”‚ â”œâ”€â”€ core/settings.py â† JWT + CORS + é‚®ä»¶é…ç½®
â”‚ â”œâ”€â”€ core/urls.py â† /auth/... è·¯ç”±
â”‚ â”œâ”€â”€ users/
â”‚ â”‚ â”œâ”€â”€ models.py â† è‡ªå®šä¹‰ User æ¨¡å‹
â”‚ â”‚ â”œâ”€â”€ validators.py â† å¯†ç å¤æ‚åº¦è§„åˆ™
â”‚ â”‚ â”œâ”€â”€ views.py â† LoginView, MeView, ChangePasswordView
â”‚ â”‚ â””â”€â”€ views_auth_extras.pyâ† Register / Forgot / Reset å¯†ç 
â”‚ â””â”€â”€ ...
â””â”€â”€ frontend/
â”œâ”€â”€ src/app/
â”‚ â”œâ”€â”€ login/ â† ç™»å½•é¡µ
â”‚ â”œâ”€â”€ register/ â† æ³¨å†Œé¡µ
â”‚ â”œâ”€â”€ dashboard/ â† ç”¨æˆ·ä¸»é¡µ
â”‚ â”œâ”€â”€ forgot-username/ â† å¿˜è®°è´¦å·
â”‚ â”œâ”€â”€ forgot-password/ â† å¿˜è®°å¯†ç 
â”‚ â””â”€â”€ reset-password/ â† é‡ç½®å¯†ç é¡µ
â””â”€â”€ src/components/
â””â”€â”€ ChangePasswordForm.tsx

# 2.è¯¾ç¨‹ä¸è¯¾è¡¨ç®¡ç†

summary_text = """# æ€ªç‰©è¯¾ç¨‹ç®¡ç†ç³»ç»Ÿ - ç¬¬äºŒé˜¶æ®µå¼€å‘æ€»ç»“ï¼ˆv1.1ï¼‰

## ä¸€ã€é˜¶æ®µç›®æ ‡

åœ¨å®Œæˆç”¨æˆ·ç™»å½•ã€æ³¨å†Œã€æƒé™ä½“ç³»ï¼ˆæ•™å­¦é—­ç¯åŸºç¡€ï¼‰ä¹‹åï¼Œç¬¬äºŒé˜¶æ®µä¸»è¦ç›®æ ‡æ˜¯å®ç°æ•™å­¦ç®¡ç†æ ¸å¿ƒæ¨¡å—ï¼š

1. **è¯¾ç¨‹ç®¡ç†ï¼ˆCourseï¼‰**
   - è¯¾ç¨‹ä¿¡æ¯çš„å¢åˆ æŸ¥æ”¹ï¼›
   - é™„ä»¶ä¸Šä¼ ä¸ä¸‹è½½ï¼›
   - è¯¾ç¨‹ä¸é™„ä»¶çš„è®¿é—®æƒé™ï¼›
2. **ç­çº§ä¸è¯¾è¡¨ç®¡ç†ï¼ˆClassSectionï¼‰**
   - ç­çº§çš„åˆ›å»ºã€ä¿®æ”¹ã€åˆ é™¤ï¼›
   - ä¸åŒè§’è‰²çš„æ“ä½œæƒé™ï¼›
   - æ”¯æŒè¯¾ç¨‹-ç­çº§-æ•™å¸ˆçš„å¯¹åº”å…³ç³»ï¼›
   - æ”¯æŒå‰ç«¯ç­çº§ç®¡ç†ç•Œé¢ã€‚

---

## äºŒã€ç³»ç»ŸåŠŸèƒ½ç»“æ„

```
æ•™å­¦ç®¡ç†æ¨¡å—
â”œâ”€â”€ è¯¾ç¨‹ç®¡ç†ï¼ˆCourseï¼‰
â”‚   â”œâ”€â”€ è¯¾ç¨‹åŸºæœ¬ä¿¡æ¯ï¼šä»£ç ã€åç§°ã€æè¿°ã€å­¦åˆ†
â”‚   â”œâ”€â”€ è¯¾ç¨‹é™„ä»¶ï¼ˆCourseAttachmentï¼‰
â”‚   â”‚   â”œâ”€â”€ æ–‡ä»¶ä¸Šä¼ ï¼ˆS3 / MinIO å­˜å‚¨ï¼‰
â”‚   â”‚   â”œâ”€â”€ ä¸‹è½½ï¼ˆæ”¯æŒæœ¬åœ° / ç»å¯¹è·¯å¾„å…œåº•ï¼‰
â”‚   â”‚   â”œâ”€â”€ åˆ é™¤ï¼ˆå¸¦æƒé™æ§åˆ¶ï¼‰
â”‚   â”‚   â””â”€â”€ åˆ—è¡¨ä¸é¢„è§ˆï¼ˆæŒ‰è¯¾ç¨‹è¿‡æ»¤ï¼‰
â”‚   â””â”€â”€ æƒé™æ§åˆ¶ï¼š
â”‚       â”œâ”€â”€ manager / registrarï¼šåˆ›å»ºã€ç¼–è¾‘ã€åˆ é™¤è¯¾ç¨‹
â”‚       â”œâ”€â”€ teacher / studentï¼šä»…æŸ¥çœ‹è¯¾ç¨‹ä¸é™„ä»¶
â”‚
â””â”€â”€ ç­çº§ç®¡ç†ï¼ˆClassSectionï¼‰
    â”œâ”€â”€ ç­çº§åŸºæœ¬ä¿¡æ¯ï¼šå­¦æœŸã€ç­å·ã€æ•™å¸ˆã€å®¹é‡ã€çŠ¶æ€ç­‰
    â”œâ”€â”€ è¯¾ç¨‹ä¸æ•™å¸ˆå…³è”
    â”œâ”€â”€ çŠ¶æ€ï¼šdraft / published / archived
    â”œâ”€â”€ æƒé™æ§åˆ¶ï¼š
    â”‚   â”œâ”€â”€ manager / registrarï¼šæ‰€æœ‰ç­çº§å¯ç®¡ç†
    â”‚   â”œâ”€â”€ teacherï¼šä»…èƒ½ç¼–è¾‘è‡ªå·±ä»»æ•™çš„ç­çº§
    â”‚   â””â”€â”€ studentï¼šåªè¯»è®¿é—®
    â””â”€â”€ è¯¾è¡¨å±•ç¤ºï¼ˆteacher å¯è§æ‰€æœ‰ç­çº§ï¼Œä½†ä»…å¯ä¿®æ”¹è‡ªå·±è´Ÿè´£çš„ï¼‰
```

---

## ä¸‰ã€åç«¯éƒ¨åˆ†ï¼ˆDjango + DRFï¼‰

### 1ï¸âƒ£ è¯¾ç¨‹æ¨¡å‹

```python
class Course(models.Model):
    code = models.CharField(max_length=32, unique=True)
    title = models.CharField(max_length=128)
    description = models.TextField(blank=True)
    credits = models.DecimalField(max_digits=4, decimal_places=1, default=3.0)
    updated_at = models.DateTimeField(auto_now=True)
```

### 2ï¸âƒ£ é™„ä»¶æ¨¡å‹

```python
class CourseAttachment(models.Model):
    course = models.ForeignKey("catalog.Course", on_delete=models.CASCADE, related_name="attachments")
    title = models.CharField(max_length=255, blank=True)
    file = models.FileField(upload_to=course_attachment_upload_to)
    uploaded_by = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.SET_NULL, null=True)
    size = models.PositiveIntegerField(default=0)
    created_at = models.DateTimeField(auto_now_add=True)
```

ğŸ“¦ å­˜å‚¨æ–¹å¼ï¼š

- æœ¬åœ°æ¨¡å¼ï¼š`/media/courses/<code>/attachments/`
- ç”Ÿäº§æ¨¡å¼ï¼šMinIO / S3
- Django é€šè¿‡ `django-storages` + `boto3` ç»Ÿä¸€ç®¡ç†ã€‚

---

### 3ï¸âƒ£ ç­çº§æ¨¡å‹

```python
class ClassSection(models.Model):
    course = models.ForeignKey(Course, on_delete=models.CASCADE, related_name="sections")
    section_code = models.CharField(max_length=32)
    term = models.CharField(max_length=64)
    teacher = models.ForeignKey(settings.AUTH_USER_MODEL, on_delete=models.PROTECT)
    capacity = models.PositiveIntegerField(default=50)
    status = models.CharField(max_length=16, choices=[("draft","draft"),("published","published"),("archived","archived")])
```

---

### 4ï¸âƒ£ æƒé™ä½“ç³»

| æ¨¡å—                 | æƒé™é€»è¾‘                                                         |
| -------------------- | ---------------------------------------------------------------- |
| **Course**           | ä»… `manager` / `registrar` å¯å†™                                  |
| **CourseAttachment** | ä»… `manager` / `registrar` å¯ä¸Šä¼  / åˆ é™¤ï¼›å…¶ä»–åªè¯»               |
| **ClassSection**     | `manager` / `registrar` å¯ç®¡ç†å…¨éƒ¨ï¼Œ`teacher` ä»…å¯æ”¹è‡ªå·±ä»»æ•™çš„ç­ |

---

### 5ï¸âƒ£ æ¥å£ä¸è·¯ç”±

- è¯¾ç¨‹æ¥å£ `/api/courses/`
- ç­çº§æ¥å£ `/api/sections/`
- é™„ä»¶æ¥å£ `/api/course_attachments/?course=<id>`

---

## å››ã€å‰ç«¯éƒ¨åˆ†ï¼ˆNext.js + Tailwindï¼‰

### 1ï¸âƒ£ è¯¾ç¨‹ç®¡ç†é¡µ `/courses`

- æŸ¥çœ‹ / æœç´¢è¯¾ç¨‹
- æ–°å»º / åˆ é™¤è¯¾ç¨‹ï¼ˆä»…ç®¡ç†å‘˜ï¼‰
- å±•å¼€é™„ä»¶ç®¡ç†ï¼ˆä¸Šä¼  / ä¸‹è½½ / åˆ é™¤ï¼‰

### 2ï¸âƒ£ ç­çº§ç®¡ç†é¡µ `/sections`

- æŸ¥çœ‹ / æœç´¢ç­çº§
- æ–°å»º / ç¼–è¾‘ / åˆ é™¤ï¼ˆæƒé™æ§åˆ¶ï¼‰
- ä»…æ•™å¸ˆå¯ä¿®æ”¹è‡ªå·±ä»»æ•™çš„ç­

### 3ï¸âƒ£ é™„ä»¶ç»„ä»¶ï¼ˆCourseAttachmentsï¼‰

- ä¸Šä¼ ï¼ˆmultipart/form-dataï¼‰
- ä¸‹è½½ï¼ˆå‰ç«¯å…œåº•ç›¸å¯¹è·¯å¾„ï¼‰
- åˆ é™¤ï¼ˆæƒé™æ ¡éªŒï¼‰
- ä¸Šä¼ æˆåŠŸæç¤º + è‡ªåŠ¨åˆ·æ–°

---

## äº”ã€é˜¶æ®µæˆæœ

| åŠŸèƒ½æ¨¡å—                   | çŠ¶æ€      | è¯´æ˜                      |
| -------------------------- | --------- | ------------------------- |
| ç”¨æˆ·æ³¨å†Œ / ç™»å½• / JWT é‰´æƒ | âœ… å·²å®Œæˆ | å…¨é—­ç¯                    |
| å¯†ç è§„åˆ™éªŒè¯ä¸ä¿®æ”¹         | âœ… å·²å®Œæˆ | å«å‰ç«¯æç¤ºä¸åç«¯éªŒè¯      |
| è¯¾ç¨‹ç®¡ç†                   | âœ… å·²å®Œæˆ | å¢åˆ æŸ¥ã€é™„ä»¶åŠŸèƒ½          |
| è¯¾ç¨‹é™„ä»¶ä¸Šä¼ /ä¸‹è½½          | âœ… å·²å®Œæˆ | æ”¯æŒæœ¬åœ°å’Œ MinIO          |
| ç­çº§ç®¡ç†ï¼ˆClassSectionï¼‰   | âœ… å·²å®Œæˆ | å«è§’è‰²æƒé™æ§åˆ¶            |
| æ•°æ®åº“è¿ç§»ä¸æµ‹è¯•           | âœ… å·²é€šè¿‡ | pytest è¦†ç›– CRUD æƒé™é€»è¾‘ |

---

## å…­ã€ä¸‹ä¸€é˜¶æ®µè§„åˆ’ï¼ˆv1.2ï¼‰

| æ–¹å‘        | å†…å®¹                                   |
| ----------- | -------------------------------------- |
| ğŸ“š æ•™å­¦å†…å®¹ | è¯¾ä»¶ã€ä½œä¸šã€èµ„æ–™ç®¡ç†ï¼ˆå…³è”è¯¾ç¨‹ä¸ç­çº§ï¼‰ |
| ğŸ“† æ•™å¸ˆè¯¾è¡¨ | æ•™å¸ˆè¯¾è¡¨è‡ªåŠ¨ç”Ÿæˆä¸å‘¨è§†å›¾å±•ç¤º           |
| ğŸ“ˆ æ•°æ®ç»Ÿè®¡ | è¯¾ç¨‹å¼€è®¾æƒ…å†µã€é€‰è¯¾äººæ•°ç»Ÿè®¡             |
| ğŸ”” é€šçŸ¥å…¬å‘Š | æ•™å¸ˆå‘å¸ƒè¯¾ç¨‹å…¬å‘Šã€å­¦ç”Ÿæ¥æ”¶æé†’         |
| ğŸ“¨ å¼‚æ­¥ä»»åŠ¡ | å¯ç”¨ Celery + Redis å®ç°æ‰¹é‡å¯¼å…¥/å¯¼å‡º  |

---

## âœ… å°ç»“

ç¬¬äºŒé˜¶æ®µå·²å®ç°æ•™å­¦æ ¸å¿ƒæ•°æ®é—­ç¯ï¼Œè¯¾ç¨‹ä¸ç­çº§åŠŸèƒ½å‡å…·å¤‡ï¼š

- ç®¡ç†å‘˜ç«¯è¯¾ç¨‹ä¸ç­çº§çš„å®Œæ•´ç®¡ç†èƒ½åŠ›ï¼›
- æ•™å¸ˆç«¯è¯¾ç¨‹èµ„æ–™ä¸Šä¼ èƒ½åŠ›ï¼›
- å­¦ç”Ÿç«¯è¯¾ç¨‹ä¸é™„ä»¶æµè§ˆåŠŸèƒ½ï¼›

> ç³»ç»Ÿç°å·²å…·å¤‡æ•™å­¦ç®¡ç†çš„æœ€å°å¯è¿è¡Œç‰ˆæœ¬ï¼ˆMVP v1.1ï¼‰ã€‚

# 3.åŠŸèƒ½æ¨¡å—ï¼šCelery + Redis å¼‚æ­¥ä»»åŠ¡ç³»ç»Ÿ

ğŸ“¦ Celery + Redis å¼‚æ­¥ä»»åŠ¡ç³»ç»Ÿå¼€å‘æ€»ç»“ (v1.2)

## ğŸ¯ ç›®æ ‡

å®ç° **è¯¾ç¨‹ä¸ç­çº§çš„æ‰¹é‡å¯¼å…¥ / å¯¼å‡ºåŠŸèƒ½**ï¼Œé˜²æ­¢å‰ç«¯é˜»å¡æˆ–æ¥å£è¶…æ—¶ã€‚  
é€šè¿‡ Celery + Redis å°†è€—æ—¶æ“ä½œæ”¾å…¥åå°å¼‚æ­¥æ‰§è¡Œï¼ŒDjango åªè´Ÿè´£â€œä¸‹ä»»åŠ¡å• + æŸ¥ä»»åŠ¡çŠ¶æ€â€ã€‚

---

## ğŸ§  ç³»ç»Ÿè®¾è®¡æ€è·¯

### 1ï¸âƒ£ æŠ€æœ¯ç»“æ„

| ç»„ä»¶                 | ä½œç”¨                                               |
| -------------------- | -------------------------------------------------- |
| **Redis**            | æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆBrokerï¼‰+ ä»»åŠ¡ç»“æœç¼“å­˜ï¼ˆResult Backendï¼‰ |
| **Celery Worker**    | åå°å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œå™¨                                 |
| **Django**           | æä¾› APIï¼ˆåˆ›å»ºä»»åŠ¡ã€æŸ¥è¯¢çŠ¶æ€ï¼‰                     |
| **MinIO / æœ¬åœ°å­˜å‚¨** | å­˜æ”¾å¯¼å‡º/å¯¼å…¥çš„ CSV æ–‡ä»¶                           |
| **å‰ç«¯ï¼ˆNext.jsï¼‰**  | æäº¤ä»»åŠ¡ â†’ è½®è¯¢çŠ¶æ€ â†’ æ˜¾ç¤ºè¿›åº¦ / ä¸‹è½½ç»“æœ          |

---

## âš™ï¸ åç«¯å®ç°ç»†èŠ‚

### ğŸ§© 1. Celery åŸºç¡€é…ç½®

```python
CELERY_BROKER_URL = "redis://localhost:6379/0"
CELERY_RESULT_BACKEND = CELERY_BROKER_URL
CELERY_TASK_TIME_LIMIT = 600
```

Celery Worker ä¸ Django å…±ç”¨ç›¸åŒ `.env` æ•°æ®åº“é…ç½®ã€‚

### ğŸ§© 2. æ–‡ä»¶å­˜å‚¨å·¥å…·

```python
from django.core.files.storage import default_storage
from django.core.files.base import ContentFile

def save_bytes(path: str, data: bytes) -> str:
    final_path = default_storage.save(path, ContentFile(data))
    return default_storage.url(final_path)
```

### ğŸ§© 3. å¼‚æ­¥ä»»åŠ¡å®šä¹‰

**å¯¼å‡ºä»»åŠ¡ï¼š**

```python
@shared_task(bind=True)
def export_courses_task(self, filters=None):
    from catalog.models import Course
    import csv, io
    from datetime import datetime
    qs = Course.objects.all().order_by("id")
    buf = io.StringIO()
    w = csv.writer(buf)
    w.writerow(["id","code","title","credits"])
    for c in qs:
        w.writerow([c.id, c.code, c.title, c.credits])
    data = buf.getvalue().encode("utf-8-sig")
    key = f"exports/courses_{datetime.now().strftime('%Y%m%d_%H%M%S')}.csv"
    url = save_bytes(key, data)
    return {"status":"success","download_url":url,"count":qs.count()}
```

**å¯¼å…¥ä»»åŠ¡ï¼š**

```python
@shared_task(bind=True)
def import_courses_task(self, storage_path):
    raw = read_bytes(storage_path)
    text = raw.decode("utf-8-sig")
    reader = csv.DictReader(io.StringIO(text))
    ok, fail = 0, 0
    for row in reader:
        code = (row.get("code") or "").strip()
        if not code: continue
        Course.objects.update_or_create(
            code=code,
            defaults={
                "title": row.get("title") or "",
                "description": row.get("description") or "",
                "credits": row.get("credits") or "3.0",
            },
        )
        ok += 1
    return {"status":"success","ok":ok,"fail":fail}
```

### ğŸ§© 4. API è®¾è®¡

| Endpoint                | æ–¹æ³•   | æè¿°                         |
| ----------------------- | ------ | ---------------------------- |
| `/api/exports/courses`  | `POST` | åˆ›å»ºè¯¾ç¨‹å¯¼å‡ºä»»åŠ¡             |
| `/api/imports/courses`  | `POST` | ä¸Šä¼  CSV å¹¶åˆ›å»ºå¯¼å…¥ä»»åŠ¡      |
| `/api/tasks/<task_id>`  | `GET`  | æŸ¥è¯¢ä»»åŠ¡çŠ¶æ€ä¸ç»“æœ           |
| `/api/exports/sections` | `POST` | å¯¼å‡ºç­çº§ï¼ˆClassSectionï¼‰æ•°æ® |

**è¿”å›ç¤ºä¾‹ï¼š**

```json
{
  "state": "SUCCESS",
  "result": {
    "status": "success",
    "download_url": "/media/exports/courses_20251014_002105.csv",
    "count": 5
  }
}
```

### ğŸ§© 5. è¿è¡Œæµç¨‹

```bash
# å¯åŠ¨ Redis
docker run -d --name redis -p 6379:6379 redis:7

# å¯åŠ¨ Django
python manage.py runserver 8000

# å¯åŠ¨ Celery Worker
celery -A core worker -l info
```

---

## ğŸ’» å‰ç«¯å®ç°ç»†èŠ‚ï¼ˆNext.jsï¼‰

### ğŸ“¤ æ‰¹é‡å¯¼å‡º/å¯¼å…¥ç»„ä»¶

**src/components/CourseBulkIO.tsx**

- æä¾›å¯¼å‡ºè¯¾ç¨‹ CSV æŒ‰é’®ï¼›
- æ”¯æŒå¯¼å…¥ CSV ä¸Šä¼ ï¼›
- è‡ªåŠ¨è½®è¯¢ä»»åŠ¡çŠ¶æ€å¹¶æç¤ºç»“æœã€‚

```tsx
const data = await authFetch("/api/exports/courses", { method: "POST" });
const { task_id } = data;
const timer = setInterval(async () => {
  const s = await authFetch(`/api/tasks/${task_id}`);
  if (s.state === "SUCCESS") {
    clearInterval(timer);
    window.open(API_BASE + s.result.download_url, "_blank");
  }
}, 2000);
```

---

## âœ… å®ç°æˆæœ

| æ¨¡å—               | åŠŸèƒ½ç‚¹               | è¯´æ˜                              |
| ------------------ | -------------------- | --------------------------------- |
| ğŸ§® Celery å¼‚æ­¥ä»»åŠ¡ | åå°æ‰§è¡Œå¯¼å…¥å¯¼å‡º     | é˜²æ­¢è¯·æ±‚è¶…æ—¶                      |
| ğŸ“¦ Redis           | ä»»åŠ¡é˜Ÿåˆ— / ç»“æœå­˜å‚¨  | `redis://localhost:6379/0`        |
| ğŸ“‚ æ–‡ä»¶å­˜å‚¨        | æœ¬åœ°æˆ– MinIO         | å¯¼å‡ºç»“æœä¿å­˜ä¸è®¿é—®                |
| ğŸ§¾ å¯¼å‡ºä»»åŠ¡        | è¯¾ç¨‹ / ç­çº§ CSV      | æ”¯æŒ filters                      |
| ğŸ“¥ å¯¼å…¥ä»»åŠ¡        | è¯¾ç¨‹æ‰¹é‡å¯¼å…¥         | ä»¥ code ä¸ºè‡ªç„¶é”® upsert           |
| ğŸ” çŠ¶æ€æŸ¥è¯¢æ¥å£    | `/api/tasks/<id>`    | å®æ—¶çŠ¶æ€ PENDING/PROGRESS/SUCCESS |
| ğŸ–¥ï¸ å‰ç«¯é›†æˆ        | è‡ªåŠ¨è½®è¯¢ã€ä¸‹è½½ã€æç¤º | ä¸€é”®å¯¼å…¥å¯¼å‡º                      |

---

## ğŸš€ åç»­å¯æ‰©å±•

- å¯¼å‡ºæ•™å¸ˆè¯¾è¡¨ã€æˆç»©å•ï¼›
- Celery Beat å®šæ—¶ä»»åŠ¡ï¼ˆå‘¨æŠ¥/è‡ªåŠ¨å¯¼å‡ºï¼‰ï¼›
- é”™è¯¯æŠ¥å‘Š CSV ç”Ÿæˆï¼›
- ä»»åŠ¡æŒä¹…åŒ–ï¼ˆæ•°æ®åº“è®°å½•è¿›åº¦ï¼‰ã€‚

---

## ğŸ“˜ å°ç»“

æœ¬éƒ¨åˆ†å®ç°äº†é¡¹ç›®çš„ **å¼‚æ­¥æ‰§è¡Œå¼•æ“**ï¼š

> Django æ´¾å‘ä»»åŠ¡ï¼ŒCelery + Redis å¼‚æ­¥æ‰§è¡Œï¼Œå‰ç«¯è½®è¯¢çŠ¶æ€ã€‚

å…·å¤‡ä¼ä¸šçº§ç‰¹æ€§ï¼š

- âœ… å¯æ‰©å±•æ€§ï¼ˆåˆ†å¸ƒå¼ä»»åŠ¡æ‰§è¡Œï¼‰
- âœ… å¯ç»´æŠ¤æ€§ï¼ˆç»Ÿä¸€ä»»åŠ¡æ¶æ„ï¼‰
- âœ… å¯è§†åŒ–ï¼ˆç»Ÿä¸€ä»»åŠ¡æŸ¥è¯¢æ¥å£ï¼‰
  """

# ğŸ”” é€šçŸ¥ç³»ç»Ÿå®ç°æ€»ç»“ (v1.3)

## 1ï¸âƒ£ æ ¸å¿ƒèƒ½åŠ›ä¸é—­ç¯

- **å‘å¸ƒ**ï¼šæ•™å¸ˆ/ç®¡ç†å‘˜åˆ›å»ºå…¬å‘Šï¼ˆé¢å‘å…¨ä½“å­¦ç”Ÿï¼‰ã€‚
- **æŠ•é€’**ï¼šCelery å¼‚æ­¥ç”Ÿæˆæ¯ä¸ªå­¦ç”Ÿçš„ Delivery æŠ•é€’è®°å½•ã€‚
- **é€è¾¾**ï¼šå­¦ç”Ÿè¿›å…¥æ¶ˆæ¯ä¸­å¿ƒåæ ‡è®° deliveredï¼ˆè‡ªåŠ¨æˆ–æ‰‹åŠ¨ï¼‰ã€‚
- **ç¡®è®¤**ï¼šå­¦ç”Ÿç‚¹å‡»â€œç¡®è®¤å·²è¯»â€ï¼ŒçŠ¶æ€å˜ä¸º acknowledgedã€‚
- **ç›‘ç®¡**ï¼šæ•™å¸ˆæŸ¥çœ‹ç¡®è®¤ç‡ã€æœªç¡®è®¤åå•ï¼Œå¯æ’¤å›ã€é‡å‘æé†’ã€‚
- **è§’æ ‡**ï¼šæœªè¯»æ•° = Delivery.state != acknowledgedã€‚

## 2ï¸âƒ£ åç«¯ç»“æ„ï¼ˆDjango + DRF + Celeryï¼‰

### æ¨¡å‹

**Announcement**

- title, body, audience, publisher, status, publish_at, created_at, updated_at

**Delivery**

- announcement, user, state(queued/delivered/acknowledged), delivered_at, ack_at, last_push_at, retry_count
- å”¯ä¸€çº¦æŸ (announcement, user)ï¼Œç´¢å¼• (user,state)ã€(announcement)

### ä¸»è¦æ¥å£

| Endpoint                                | æ–¹æ³• | è¯´æ˜                                 |
| --------------------------------------- | ---- | ------------------------------------ |
| /api/announcements/                     | POST | æ•™å¸ˆåˆ›å»ºå…¬å‘Šï¼Œåå°è§¦å‘ Celery fanout |
| /api/announcements/{id}/withdraw/       | POST | æ’¤å›å…¬å‘Š                             |
| /api/announcements/{id}/stats/          | GET  | ç»Ÿè®¡ç¡®è®¤ç‡                           |
| /api/announcements/{id}/remind_unacked/ | POST | é‡å‘æé†’ï¼ˆæ›´æ–° retry_countï¼‰         |
| /api/deliveries/                        | GET  | å­¦ç”Ÿæ”¶ä»¶ç®±                           |
| /api/deliveries/{id}/delivered/         | POST | æ ‡è®°å·²å±•ç¤º                           |
| /api/deliveries/{id}/ack/               | POST | ç¡®è®¤å·²è¯»                             |
| /api/unread_count                       | GET  | è¿”å›æœªè¯»æ•°                           |

### çŠ¶æ€æœº

å‘å¸ƒ (published) â†’ fanout_all_students (Celery)
â†’ Delivery: queued â†’ delivered â†’ acknowledged

### Celery ä»»åŠ¡

- fanout_all_students(announcement_id)ï¼šä¸ºæ‰€æœ‰å­¦ç”Ÿåˆ›å»º Deliveryï¼ˆåˆ†æ‰¹ã€å¹‚ç­‰ï¼‰ã€‚
- é¢„ç•™ï¼špush_notify_unackedã€daily_digest_unackedã€‚

## 3ï¸âƒ£ å‰ç«¯ç»“æ„ï¼ˆNext.jsï¼‰

### /messages é¡µé¢

Tabs:

- æ”¶ä»¶ç®±ï¼ˆå­¦ç”Ÿï¼‰: æ ‡é¢˜ã€å‘å¸ƒè€…ã€æ—¶é—´ã€çŠ¶æ€ï¼›æ“ä½œï¼šæ ‡è®°å·²å±•ç¤ºã€ç¡®è®¤å·²è¯»ã€‚
- æˆ‘å‘å¸ƒçš„ï¼ˆæ•™å¸ˆ/ç®¡ç†å‘˜ï¼‰: å‘å¸ƒè¡¨å•ã€åˆ—è¡¨ï¼ˆç»Ÿè®¡ã€æ’¤å›ã€é‡å‘æé†’ï¼‰ã€‚

è§’æ ‡ï¼šè°ƒç”¨ /api/unread_count è·å–æ•°å­—æ˜¾ç¤ºåœ¨é“ƒé“›ã€‚

çŠ¶æ€æµï¼šqueued â†’ delivered â†’ acknowledged

## 4ï¸âƒ£ æƒé™ä¸è§’è‰²æ§åˆ¶

| è§’è‰²              | æƒé™                                     |
| ----------------- | ---------------------------------------- |
| student           | æŸ¥çœ‹æ”¶ä»¶ç®±ã€ç¡®è®¤å·²è¯»                     |
| teacher           | å‘å¸ƒã€æŸ¥çœ‹è‡ªå·±å…¬å‘Šã€æŸ¥çœ‹ç»Ÿè®¡ã€æ’¤å›ã€æé†’ |
| manager/registrar | å…¨é‡ç®¡ç†æ‰€æœ‰å…¬å‘Š                         |

## 5ï¸âƒ£ æ€§èƒ½ä¸å¯é æ€§

- Celery åˆ†æ‰¹ bulk_create(ignore_conflicts=True)ï¼ˆ500 ï½ 1000/æ‰¹ï¼‰ã€‚
- ACKã€delivered å¹‚ç­‰ã€‚
- ç´¢å¼•ä¼˜åŒ–ï¼š(user,state)ã€(announcement)ã€‚

## 6ï¸âƒ£ è°ƒè¯•ä¸è”è°ƒ

curl -X POST /api/announcements/
curl -H Authorization:Student /api/deliveries
curl -X POST /api/deliveries/1/ack/
curl -H Authorization:Teacher /api/announcements/1/stats/

## 7ï¸âƒ£ å¯è¿ç»´ä¸å¯è§‚æµ‹

- ç›‘æ§ Celery fanout æˆåŠŸ/å¤±è´¥ã€‚
- æ•™å¸ˆæŸ¥çœ‹ç¡®è®¤ç‡ã€æé†’æ¬¡æ•°ã€‚
- å¼‚å¸¸è‡ªåŠ¨é‡è¯•ã€‚

## 8ï¸âƒ£ åç»­æ‹“å±•æ–¹å‘

- æŒ‰è¯¾ç¨‹/ç­çº§å—ä¼—ã€‚
- å®æ—¶æ¨é€ (WS/SSE + Redis)ã€‚
- é‚®ä»¶/Push é€šçŸ¥ã€‚
- æœªç¡®è®¤åå•å¯¼å‡º CSVã€‚
- å¯Œæ–‡æœ¬å…¬å‘Šã€é™„ä»¶ã€ç¼–è¾‘å†å²ã€‚

## âœ… å°ç»“

> å®ç°äº†å‘å¸ƒ â†’ æŠ•é€’ â†’ é€è¾¾ â†’ ç¡®è®¤ â†’ ç»Ÿè®¡é—­ç¯ã€‚
> Delivery ç¡®ä¿å¯é é€è¾¾ï¼ŒCelery å¼‚æ­¥ä¿éšœæ€§èƒ½ã€‚
> æƒé™åŸºäºç”¨æˆ·è§’è‰²ï¼Œå¯æ‰©å±•ã€å¯ç›‘æ§ã€å¯æ¼”è¿›ã€‚
> """

## ğŸ“¦ é€šçŸ¥ç³»ç»Ÿä¸­çš„é˜Ÿåˆ—æœºåˆ¶è¯´æ˜ (v1.3)

## ä¸€ã€ç³»ç»Ÿä¸­ä½¿ç”¨é˜Ÿåˆ—çš„éƒ¨åˆ†

å½“å‰é€šçŸ¥ç³»ç»Ÿé‡‡ç”¨ **Celery + Redis** å®ç°å¼‚æ­¥ä»»åŠ¡å¤„ç†ï¼Œå…¶ä¸­ Redis ä½œä¸º **æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMessage Brokerï¼‰**ã€‚

### é˜Ÿåˆ—çš„ä¸»è¦ç”¨é€”

| é˜¶æ®µ            | åŠ¨ä½œ                                                              | è¯´æ˜                       |
| --------------- | ----------------------------------------------------------------- | -------------------------- |
| æ•™å¸ˆå‘å¸ƒå…¬å‘Š    | Django ä¿å­˜ Announcement â†’ è°ƒç”¨ `fanout_all_students.delay(a.id)` | å°†ä»»åŠ¡æ¶ˆæ¯æ¨å…¥ Redis é˜Ÿåˆ—  |
| Worker ç›‘å¬é˜Ÿåˆ— | `celery -A core worker -l info` ç›‘å¬ä»»åŠ¡é˜Ÿåˆ—                      | Worker ä» Redis å–ä»»åŠ¡æ‰§è¡Œ |
| Worker æ‰§è¡Œä»»åŠ¡ | æ‰¹é‡ä¸ºæ¯ä¸ªå­¦ç”Ÿç”Ÿæˆ Delivery æŠ•é€’è®°å½•                              | å¼‚æ­¥æ‰§è¡Œï¼Œé¿å…ä¸»çº¿ç¨‹é˜»å¡   |
| Worker å®Œæˆä»»åŠ¡ | å†™å…¥æ•°æ®åº“å¹¶è®°å½•ç»“æœ                                              | å¯è‡ªåŠ¨é‡è¯•æˆ–ç›‘æ§çŠ¶æ€       |

**æ€»ç»“**ï¼šé˜Ÿåˆ—ä½¿ç³»ç»Ÿèƒ½é«˜æ•ˆå¼‚æ­¥åœ°å¤„ç†â€œå…¬å‘Šæ‰¹é‡æŠ•é€’â€è¿™ä¸€è€—æ—¶ä»»åŠ¡ã€‚

---

## äºŒã€ç³»ç»Ÿè¿è¡Œé€»è¾‘

```
æ•™å¸ˆå‘å¸ƒå…¬å‘Šï¼ˆHTTP è¯·æ±‚ï¼‰
      â†“
Django ä¿å­˜ Announcement
      â†“
Celery.delay() æŠŠä»»åŠ¡æ”¾å…¥ Redis é˜Ÿåˆ—
      â†“
Celery Worker ä»é˜Ÿåˆ—å–ä»»åŠ¡
      â†“
æ‰¹é‡åˆ›å»º Deliveryï¼ˆæ¯ä¸ªå­¦ç”Ÿä¸€æ¡ï¼‰
      â†“
ä»»åŠ¡å®Œæˆ
```

### é˜Ÿåˆ—å¸¦æ¥çš„å¥½å¤„

| ç»´åº¦     | ä¼˜åŠ¿                                      |
| -------- | ----------------------------------------- |
| æ€§èƒ½     | å‘å¸ƒå…¬å‘Šæ— éœ€ç­‰å¾…æ‰¹é‡å†™å…¥ï¼Œè¿”å›é€Ÿåº¦å¿«      |
| å¯é æ€§   | Celery è‡ªåŠ¨é‡è¯•ï¼Œä»»åŠ¡å¤±è´¥ä¸ä¼šä¸¢å¤±         |
| å¯æ‰©å±•æ€§ | æ”¯æŒå¤š worker å¹¶å‘å¤„ç†ä¸Šåƒç”¨æˆ·            |
| å¯è§‚æµ‹æ€§ | Celery å¯æŸ¥çœ‹ä»»åŠ¡æ‰§è¡ŒçŠ¶æ€ SUCCESS/FAILURE |

---

## ä¸‰ã€å‰ç«¯ä¸é˜Ÿåˆ—çš„å…³ç³»

å½“å‰å‰ç«¯ï¼ˆæ¶ˆæ¯ä¸­å¿ƒï¼‰**ä¸ç›´æ¥è¿æ¥é˜Ÿåˆ—**ã€‚

- å­¦ç”Ÿç«¯é€šè¿‡ HTTP API è½®è¯¢æ¶ˆæ¯çŠ¶æ€ï¼›
- é˜Ÿåˆ—ä»…åœ¨åç«¯å­˜åœ¨ï¼Œç”¨äºå¼‚æ­¥å¤„ç†ï¼›
- è‹¥æœªæ¥å‡çº§å®æ—¶æ¨é€ï¼ˆWebSocket/SSEï¼‰ï¼ŒCelery + Redis ä»å¯ä½œä¸ºåˆ†å‘å±‚ã€‚

---

## å››ã€ç³»ç»Ÿæ¨¡å—ä¸é˜Ÿåˆ—å…³ç³»å¯¹ç…§

| åŠŸèƒ½æ¨¡å—                           | æ˜¯å¦ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—  | ç”¨é€”                   |
| ---------------------------------- | ----------------- | ---------------------- |
| æ•™å¸ˆå‘å¸ƒå…¬å‘Š â†’ fanout_all_students | âœ… æ˜¯             | å¼‚æ­¥ç”ŸæˆæŠ•é€’è®°å½•       |
| å­¦ç”Ÿæ”¶ä»¶ç®± / ç¡®è®¤å·²è¯»              | âŒ å¦             | ç›´æ¥è®¿é—®æ•°æ®åº“         |
| æ•™å¸ˆé‡å‘æé†’                       | âœ… æ˜¯ï¼ˆæœªæ¥æ‰©å±•ï¼‰ | å¼‚æ­¥é€šçŸ¥ã€é‚®ä»¶æ¨é€     |
| WebSocket å®æ—¶æ¨é€                 | âœ… æ˜¯ï¼ˆæœªæ¥æ‰©å±•ï¼‰ | Redis Pub/Sub åˆ†å‘äº‹ä»¶ |

---

## äº”ã€æ€»ç»“

é€šçŸ¥ç³»ç»Ÿçš„å¼‚æ­¥é˜Ÿåˆ—æœºåˆ¶æ‰¿æ‹…â€œåå°æ‰¹é‡åˆ†å‘â€çš„ä»»åŠ¡ï¼š

> Django ä¸»è¿›ç¨‹è´Ÿè´£æ´¾å‘ä»»åŠ¡ï¼ŒCelery Worker é€šè¿‡ Redis é˜Ÿåˆ—å¼‚æ­¥æ‰§è¡Œã€‚

è¿™æ ·æ—¢æå‡äº†æ€§èƒ½ï¼Œä¹Ÿç¡®ä¿äº†ä»»åŠ¡çš„å¯é æ€§å’Œå¯æ‰©å±•æ€§ã€‚

# å¤šç”¨æˆ·è¿æ¥æ± æŠ€æœ¯æ¦‚å¿µè¯¦è§£

æœ¬è¯´æ˜æ—¨åœ¨æ¢³ç†å½“å‰é¡¹ç›®ä¸­æ¶‰åŠçš„æ‰€æœ‰â€œè¿æ¥æ± åŒ–â€æœºåˆ¶ï¼Œå¸®åŠ©å›¢é˜Ÿç†è§£å®ƒä»¬çš„å®šä½ã€è§£å†³çš„é—®é¢˜ã€ä¼˜ç¼ºç‚¹ä¸é€‚ç”¨è¾¹ç•Œã€‚

---

## 1ï¸âƒ£ æ•°æ®åº“è¿æ¥æ± 

### Django è‡ªå¸¦æŒä¹…è¿æ¥ï¼ˆ`CONN_MAX_AGE`ï¼‰

- **å®šä¹‰**ï¼šåœ¨ Django è¿›ç¨‹å†…ç»´æŒ TCP è¿æ¥å¤ç”¨ï¼Œé¿å…æ¯æ¬¡è¯·æ±‚éƒ½é‡å»ºè¿æ¥ã€‚
- **ä½œç”¨**ï¼šé™ä½è¿æ¥å»ºç«‹å¼€é”€ï¼Œæé«˜å»¶è¿Ÿç¨³å®šæ€§ã€‚
- **è¾¹ç•Œ**ï¼šä»…é™å•è¿›ç¨‹ï¼Œæ— æ³•è·¨å®¹å™¨æˆ–å®ä¾‹å…±äº«è¿æ¥ã€‚
- **ä¼˜ç‚¹**ï¼šç®€å•ã€æ— ä¾èµ–ã€‚
- **ç¼ºç‚¹**ï¼šæ— æ³•é™æµæˆ–é˜Ÿåˆ—ï¼Œä»å¯èƒ½è§¦å‘æ•°æ®åº“è¿æ¥è¿‡è½½ã€‚
- **é€‚ç”¨åœºæ™¯**ï¼šå¼€å‘æˆ–ä½å¹¶å‘ç¯å¢ƒï¼›å¯ä¸ PgBouncer ç»„åˆä½¿ç”¨ã€‚

### PgBouncerï¼ˆå¤–éƒ¨æ•°æ®åº“è¿æ¥æ± ï¼‰

- **å®šä¹‰**ï¼šPostgreSQL å®˜æ–¹æ¨èçš„è½»é‡çº§è¿æ¥æ± ä»£ç†ã€‚
- **ä½œç”¨**ï¼šå¤ç”¨åç«¯è¿æ¥ã€é›†ä¸­é™æµã€ç¼“å†²ç¬æ—¶é«˜å¹¶å‘ã€‚
- **å·¥ä½œæ¨¡å¼**ï¼š
  - `session`ï¼šè¿æ¥ç‹¬å ï¼Œä¼šè¯ç»“æŸé‡Šæ”¾ã€‚
  - `transaction`ï¼ˆæ¨èï¼‰ï¼šäº‹åŠ¡æœŸé—´å€Ÿç”¨è¿æ¥ï¼Œæ€§èƒ½é«˜ä¸”å®‰å…¨ã€‚
  - `statement`ï¼šè¯­å¥çº§å¤ç”¨ï¼Œå…¼å®¹æ€§å·®ã€‚
- **ä¼˜ç‚¹**ï¼šè·¨è¿›ç¨‹/å®¹å™¨å…±äº«æ± ï¼Œå…·å¤‡æ’é˜Ÿå’Œåå‹æœºåˆ¶ã€‚
- **ç¼ºç‚¹**ï¼šæ— æ³•ç»´æŒä¼šè¯çº§çŠ¶æ€ï¼ˆäº‹åŠ¡å¤–å˜é‡æ— æ•ˆï¼‰ã€‚
- **é€‚ç”¨åœºæ™¯**ï¼šç”Ÿäº§ç¯å¢ƒã€å¹¶å‘é‡å¤§ã€Celery Worker å…±ç”¨æ•°æ®åº“æ—¶ã€‚

---

## 2ï¸âƒ£ Redis è¿æ¥æ± 

### å®¢æˆ·ç«¯è¿æ¥æ± ï¼ˆ`redis-py` / `django-redis`ï¼‰

- **å®šä¹‰**ï¼šåœ¨åº”ç”¨ä¾§ç»´æŠ¤æœ‰é™æ•°é‡çš„åˆ° Redis çš„ TCP è¿æ¥ã€‚
- **ä½œç”¨**ï¼šå‡å°‘é¢‘ç¹å»ºè¿ã€æ§åˆ¶æœ€å¤§è¿æ¥æ•°ã€‚
- **è¾¹ç•Œ**ï¼šä»…é™å®¢æˆ·ç«¯è¿›ç¨‹ï¼ŒRedis ç«¯ä¸æ„ŸçŸ¥â€œæ± â€çš„å­˜åœ¨ã€‚
- **ä¼˜ç‚¹**ï¼šé«˜æ€§èƒ½ã€å¯é™æµã€‚
- **ç¼ºç‚¹**ï¼šéœ€è°¨æ…é…ç½®ä¸Šé™ï¼Œé˜²æ­¢çˆ†å‘å¼è¿æ¥ã€‚
- **é€‚ç”¨åœºæ™¯**ï¼šç¼“å­˜ã€åˆ†å¸ƒå¼é”ã€ä¼šè¯å­˜å‚¨ã€‚

### Celery Broker/Result è¿æ¥æ± 

- **å®šä¹‰**ï¼šCelery ä¸ Redis çš„è¿æ¥ç®¡ç†ï¼ˆBroker/Result åˆ†å¼€ç»´æŠ¤ï¼‰ã€‚
- **ä½œç”¨**ï¼šé™åˆ¶ä»»åŠ¡åˆ†å‘ä¸å›ä¼ æ—¶çš„ Redis è¿æ¥ä½¿ç”¨ã€‚
- **ä¼˜ç‚¹**ï¼šé˜²æ­¢ Worker å¹¶å‘è¿‡å¤šå¯¼è‡´è¿æ¥è€—å°½ã€‚
- **ç¼ºç‚¹**ï¼šè¿‡å°ä¼šé€ æˆä»»åŠ¡å»¶è¿Ÿã€‚
- **é€‚ç”¨åœºæ™¯**ï¼šå¼‚æ­¥ä»»åŠ¡åˆ†å‘ã€åå°å¯¼å…¥å¯¼å‡ºã€é€šçŸ¥å¹¿æ’­ç­‰ã€‚

---

## 3ï¸âƒ£ å¯¹è±¡å­˜å‚¨ï¼ˆMinIO/S3ï¼‰HTTP å¤ç”¨

- **å®šä¹‰**ï¼šåŸºäº HTTP Keep-Alive çš„æŒä¹…è¿æ¥å¤ç”¨æœºåˆ¶ã€‚
- **ä½œç”¨**ï¼šå¤ç”¨ TLS/TCP é€šé“ï¼Œé™ä½æ¡æ‰‹å’Œä¼ è¾“å¼€é”€ã€‚
- **ä¼˜ç‚¹**ï¼šé€æ˜ã€ä½æˆæœ¬ã€é«˜æ•ˆã€‚
- **ç¼ºç‚¹**ï¼šå¤§å¹¶å‘æ—¶éœ€é™åˆ¶ä¸Šä¼ å¹¶å‘ä¸åˆ†å—å¤§å°ã€‚
- **é€‚ç”¨åœºæ™¯**ï¼šè¯¾ç¨‹æ–‡ä»¶ã€è¯¾ä»¶ã€é™„ä»¶ä¸Šä¼ ä¸‹è½½ã€‚

---

## 4ï¸âƒ£ HTTP å®¢æˆ·ç«¯è¿æ¥å¤ç”¨ï¼ˆNode/Next.js æœåŠ¡ç«¯ï¼‰

- **å®šä¹‰**ï¼šNode.js é€šè¿‡ `http.Agent` ç»´æŠ¤é•¿è¿æ¥æ± ï¼Œå®ç° Keep-Aliveã€‚
- **ä½œç”¨**ï¼šé™ä½ SSR ä¸åç«¯äº¤äº’çš„ç½‘ç»œå»¶è¿Ÿã€‚
- **è¾¹ç•Œ**ï¼šä»…å¯¹æœåŠ¡ç«¯ fetch ç”Ÿæ•ˆï¼Œæµè§ˆå™¨ç«¯ç”±æµè§ˆå™¨è‡ªåŠ¨ç®¡ç†ã€‚
- **ä¼˜ç‚¹**ï¼šé™ä½æŠ–åŠ¨ã€æå‡ QPSã€‚
- **ç¼ºç‚¹**ï¼šmaxSockets è¿‡å¤§æ˜“å¯¼è‡´ API è¢«çªåˆºã€‚
- **é€‚ç”¨åœºæ™¯**ï¼šNext.js æœåŠ¡ç«¯æ¸²æŸ“ã€è°ƒç”¨ Django APIã€‚

---

## 5ï¸âƒ£ Web æœåŠ¡å™¨æ± ï¼ˆGunicorn / Uvicornï¼‰

- **å®šä¹‰**ï¼šé€šè¿‡å¤šè¿›ç¨‹/çº¿ç¨‹å½¢æˆçš„â€œè®¡ç®—æ± â€ï¼Œå®ç°å¹¶å‘è¯·æ±‚å¤„ç†ã€‚
- **ä½œç”¨**ï¼šæé«˜ååå¹¶è¡Œåº¦ï¼Œä¸æ•°æ®åº“/Redis æ± ååŒå·¥ä½œã€‚
- **ä¼˜ç‚¹**ï¼šæ‰©å±•æ€§å¥½ï¼›é€‚åˆ CPU/IO æ··åˆå‹ä»»åŠ¡ã€‚
- **ç¼ºç‚¹**ï¼šéœ€ä¸ä¸‹æ¸¸è¿æ¥æ± åŒ¹é…ï¼Œå¦åˆ™é€ æˆèµ„æºè¿‡è½½ã€‚
- **é€‚ç”¨åœºæ™¯**ï¼šç”Ÿäº§éƒ¨ç½²ï¼Œéœ€åŠ¨æ€è°ƒèŠ‚ `workers Ã— threads`ã€‚

---

## 6ï¸âƒ£ ä»»åŠ¡é˜Ÿåˆ—è¿æ¥æ± ï¼ˆCeleryï¼‰

- **å®šä¹‰**ï¼šä»»åŠ¡å±‚é¢çš„å¹¶å‘æ± ä¸è¿æ¥æ± ï¼Œç”¨äºåˆ†å‘å’Œæ‰§è¡Œå¼‚æ­¥ä»»åŠ¡ã€‚
- **ä½œç”¨**ï¼šå®ç°åå°ä»»åŠ¡çš„å¼‚æ­¥è§£è€¦ä¸é™æµã€‚
- **ä¼˜ç‚¹**ï¼šé«˜å¯æ‰©å±•ï¼Œæ”¯æŒé‡è¯•ä¸é”™å³°ã€‚
- **ç¼ºç‚¹**ï¼šé…ç½®å¤æ‚ï¼Œè¿æ¥/ä»»åŠ¡æ•°éœ€ä¸¥æ ¼ç›‘æ§ã€‚
- **é€‚ç”¨åœºæ™¯**ï¼šå¼‚æ­¥å¯¼å…¥å¯¼å‡ºã€é‚®ä»¶é€šçŸ¥ã€å…¬å‘Šæ¨é€ã€‚

---

## 7ï¸âƒ£ æ± åŒ–æœºåˆ¶çš„å…±æ€§ç‰¹å¾

| ç‰¹æ€§     | è¯´æ˜                                     |
| -------- | ---------------------------------------- |
| **å¤ç”¨** | é¿å…é¢‘ç¹å»ºè¿ã€æ¡æ‰‹ã€TLS å¼€é”€             |
| **é™æµ** | æ§åˆ¶ä¸‹æ¸¸è¿æ¥æ€»é‡ï¼Œé˜²æ­¢æ‰“çˆ†èµ„æº           |
| **éš”ç¦»** | ä¸åŒè¿›ç¨‹/ç»„ä»¶å„è‡ªç»´æŠ¤æ± ï¼Œéœ€å…¨å±€è§„åˆ’      |
| **å¹‚ç­‰** | ä»»åŠ¡é‡è¯•/æ’é˜Ÿæ—¶éœ€ä¿æŒå¹‚ç­‰æ€§              |
| **ç›‘æ§** | å¿…é¡»ç›‘æ§è¿æ¥æ•°ã€ç­‰å¾…é˜Ÿåˆ—ã€P95 å»¶æ—¶ç­‰æŒ‡æ ‡ |
| **åŒ¹é…** | ä¸Šæ¸¸ worker å¹¶å‘éœ€ä¸ä¸‹æ¸¸è¿æ¥æ± å®¹é‡åŒ¹é…   |

---

## 8ï¸âƒ£ å®è·µå»ºè®®æ€»ç»“

| ç»„ä»¶       | å»ºè®®æ–¹æ¡ˆ                                       | æ ¸å¿ƒå‚æ•°                                      |
| ---------- | ---------------------------------------------- | --------------------------------------------- |
| PostgreSQL | PgBouncer(transaction) + Django `CONN_MAX_AGE` | `default_pool_size=20`, `CONN_MAX_AGE=120`    |
| Redis      | django-redis + Celery Pool é™åˆ¶                | `max_connections=200`, `broker_pool_limit=50` |
| å¯¹è±¡å­˜å‚¨   | HTTP Keep-Alive + å¹¶å‘é˜ˆå€¼                     | å¹¶å‘ â‰¤10ï¼Œåˆ†å— â‰¥5MB                           |
| Next.js    | `http.Agent` keep-alive                        | `maxSockets=200`                              |
| Web æœåŠ¡   | Gunicorn/Uvicorn workers åˆç†é…ç½®              | `workers=CPUÃ—2`, `threads=2`                  |
| Celery     | å¹¶å‘ä¸ prefetch åŒ¹é…                           | `concurrency=4`, `prefetch=1`                 |

---

## âœ… æ€»ç»“

è¿æ¥æ± æ˜¯**é«˜å¹¶å‘ç³»ç»Ÿçš„â€œèŠ‚æµé˜€â€ä¸â€œç¨³å‹å™¨â€**ï¼š

> å®ƒé€šè¿‡å¤ç”¨ã€é™æµã€éš”ç¦»è®©ç³»ç»Ÿç¨³å®šé«˜æ•ˆåœ°åˆ©ç”¨èµ„æºï¼Œé¿å…é›ªå´©ã€‚  
> åœ¨æœ¬é¡¹ç›®ä¸­ï¼Œæ•°æ®åº“ï¼ˆPgBouncerï¼‰ã€ç¼“å­˜ï¼ˆRedisï¼‰ã€å¼‚æ­¥é˜Ÿåˆ—ï¼ˆCeleryï¼‰ä¸‰å±‚è”åŠ¨ï¼Œå½¢æˆäº†å®Œæ•´çš„â€œèµ„æºæ± åŒ–é—­ç¯â€ã€‚
> """
